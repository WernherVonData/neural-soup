---
layout: post
title:  "MeesagePack Vulnerability in public API"
date:   2000-01-01 08:00:00 +0200
categories: cpp update
---

## Introduction

In one of the old Java projects I was working with public web api that was accepting base64 encoded data. The data was decoded by Jackson library with backend of MessagePack library. One day the JVM reported allocation above 1GB after one request.

## The problem

The problem lied in the MessagePack library. The library works on the table of bytes and by the byte signatures it understands and deserializes the bytes into real objects. The problem lied in the `ext` type which stores the data as a [byte array](https://github.com/msgpack/msgpack/blob/master/spec.md#ext-format-family). The first bytes of the given requests were suggesting the ext type of length 32bits, yes the array of bytes of length 2^32-1. The library allocated the necessary memory started reading the bytes from there thinking that there will be some additional payload. The JVM was not able to allocate the memory and the application crashed.

## The solution

In the public API when the requests accepts base64 string you have no power to determine what can come in such requests. At the beginning I was thinking "maybe just check of the first byte will be enough to tell what is the signature" - WRONG. A bit later as an excercise to check if I understand the MessagePack formats I created a base64 string by hand that yes, in the beginning it was looking like a proper object for deserialization, but after the first few bytes I added Ext32 bytes and again I caused such crash.

As the solution for everything I just changed the back from jackson to json. It was a bit slower, but it's validation mechanism is a bit different and it was able to handle wild requests.

Soon after that the request stopped using base64 and this information was populated over stable resource ID.

## Conclusion

- MessagePack IS a good deserialization library, but it's not safe for public APIs, when you don't have control over the requests.
- If you are using MessagePack in your public API, check if you are not using the `ext` type, or your users/enemies can crash your application.